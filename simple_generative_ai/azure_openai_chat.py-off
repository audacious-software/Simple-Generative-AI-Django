# pylint: disable=line-too-long

import traceback

from ..models import GenerativeAIException
from . import prepare_messages

def run_model(model_obj, prompt, user='azure_user', extras=None):
    if extras is None:
        extras = {}

    parameters = model_obj.fetch_parameters()

    messages = prepare_messages(model_obj, prompt, extras)

    try:
        import openai # pylint: disable=import-outside-toplevel, import-error

        client = openai.AzureOpenAI(api_key=parameters.get('azure_openai_api_key', ''), api_version="2024-07-01-preview", api_key=parameters.get('azure_openai_endpoint', '')) # pylint: disable=no-member

        request_obj = {
            'model': parameters.get('azure_deployment_name', ''),
            'user': user,
            'messages': messages,
        }

        model_parameters = parameters.get('model_parameters', {})
        request_obj.update(model_parameters)

        chat_completion = client.chat.completions.create(**request_obj)

        model_obj.log_request(request_obj, chat_completion.model_dump(mode='json'), True)

        return chat_completion.choices[0].message.content
    except Exception as error:
        response_obj = {
            'stacktrace': traceback.format_exc()
        }

        model_obj.log_request(request_obj, response_obj, False)

        raise GenerativeAIException('Error encountered running OpenAI.chat.completions.create.') from error

def validate_model(model_obj):
    parameters = model_obj.fetch_parameters()

    issues = []

    parameters = model_obj.fetch_parameters()

    service_mode = parameters.get('service_mode', 'openai')

    if parameters.get('azure_openai_api_key', None) is None:
        issues.append('Add valid "azure_openai_api_key" parameter to model')

    if parameters.get('azure_openai_endpoint', None) is None:
        issues.append('Add valid "azure_openai_endpoint" parameter to model')

    if parameters.get('azure_deployment_name', None) is None:
        issues.append('Specify a valid "azure_deployment_name" for model (see https://learn.microsoft.com/en-us/azure/ai-foundry/openai/how-to/create-resource?pivots=web-portal#deploy-a-model)')

    return issues
